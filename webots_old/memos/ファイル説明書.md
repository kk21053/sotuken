# sotukenプロジェクト ファイル説明書

このプロジェクトは、Boston Dynamics社のSpot（四足歩行ロボット）の故障診断をドローンで行うシミュレーションシステムです。

---

## 📁 プロジェクト構成

```
sotuken/
├── ドキュメント類（.txt, .md）
├── webots/                    # メインプロジェクトフォルダ
│   ├── config/               # 設定ファイル
│   ├── controllers/          # ロボット制御プログラム
│   ├── protos/              # 3Dモデル定義
│   ├── worlds/              # シミュレーション環境
│   └── テスト・実行スクリプト
```

---

## 📄 ルートディレクトリのドキュメント

### 1. プロジェクト説明文書

| ファイル名 | 役割 |
|-----------|------|
| `README.md` | プロジェクト全体の説明書 |
| `RUN_SIMULATION.md` | シミュレーション実行手順書 |
| `梗概.txt` | 研究の概要（日本語） |
| `仕様.txt` | システム仕様書（簡易版） |
| `実装したプログラムの仕様.txt` | 実装詳細（簡易版） |
| `実装したプログラムの仕様_完全版.txt` | 実装詳細（完全版） |
| `prompt.txt` | AI開発時のプロンプト |

---

## 🎮 webots/ - シミュレーション本体

### セットアップ・実行関連

| ファイル名 | 役割 | 説明 |
|-----------|------|------|
| `LLM_QUICKSTART.md` | LLM版クイックスタート | LLM（AI）を使った診断の簡単な始め方 |
| `LLM_ADVANCED_SETUP.md` | LLM版詳細セットアップ | LLMの詳細な設定方法 |
| `requirements_llm.txt` | Pythonパッケージリスト | LLM機能に必要なライブラリ一覧 |
| `set_environment.py` | 環境セットアップスクリプト | シミュレーション環境の初期設定 |

### テスト・実行スクリプト

| ファイル名 | 役割 | 説明 |
|-----------|------|------|
| `run_all_tests.sh` | 全テスト実行スクリプト | すべてのテストを一括実行 |
| `test_rule_based.py` | ルールベース診断テスト | ルール（if-then）による診断のテスト |
| `test_llm_advanced.py` | LLM診断テスト | AI（LLM）による診断のテスト |
| `view_result.py` | 結果表示プログラム | 診断結果を見やすく表示 |

---

## ⚙️ config/ - 設定ファイル

### メイン設定

| ファイル名 | 役割 |
|-----------|------|
| `scenario.ini` | シナリオ設定ファイル | どの脚がどんな状態（正常/埋没/絡まり等）かを設定 |
| `scenario_v2.ini` | シナリオ設定v2 | 新バージョンの設定（開発中） |

### 設定例

| ファイル名 | 内容 |
|-----------|------|
| `examples/scenario_all_normal.ini` | 全脚が正常な設定例 |
| `examples/scenario_all_buried.ini` | 全脚が砂に埋まった設定例 |
| `examples/scenario_mixed.ini` | 複数の状態が混在する設定例 |

**関係性**: これらの設定ファイルは、`controllers/`内の各プログラムが読み込んで、シミュレーションの初期状態を決定します。

---

## 🤖 controllers/ - ロボット制御プログラム

### 3つのメインコントローラー

| フォルダ/ファイル | 担当ロボット/役割 | 説明 |
|-----------------|-----------------|------|
| **spot_self_diagnosis/** | Spot（四足ロボット） | Spotが自分で脚の状態を診断 |
| `spot_self_diagnosis.py` | Spot制御プログラム | - 歩行制御<br>- 自己診断（センサーデータ分析）<br>- ドローンへの診断依頼 |
| **drone_circular_controller/** | ドローン | Spotの上空を旋回して観察 |
| `drone_circular_controller.py` | ドローン制御プログラム | - 円形軌道飛行<br>- Spotの画像観察<br>- バッテリー管理<br>- 診断結果の統合 |
| **environment_manager/** | 環境マネージャー | シミュレーション環境全体を管理 |
| `environment_manager.py` | 環境制御プログラム | - 障害物の配置<br>- 環境状態の更新 |

### 診断パイプライン（共通モジュール）

`diagnostics_pipeline/` は、Spotとドローンの両方が使う**共通の診断システム**です。

| ファイル名 | 役割 | 説明 |
|-----------|------|------|
| `__init__.py` | パッケージ初期化 | このフォルダをPythonパッケージとして認識させる |
| `config.py` | 設定定義 | 診断に使う定数（脚ID、状態種類等） |
| `models.py` | データ構造定義 | 診断データを保存する型（クラス）を定義 |
| `pipeline.py` | 診断パイプライン本体 | 診断全体の流れを制御 |
| `self_diagnosis.py` | 自己診断モジュール | Spotのセンサーデータを分析 |
| `drone_observer.py` | ドローン観察モジュール | ドローンの画像データを分析 |
| `fusion.py` | データ統合モジュール | Spotとドローンの診断を統合 |
| `llm_client.py` | LLM通信クライアント | AIサーバーと通信 |
| `llm_advanced.py` | LLM診断（高度版） | AIによる高度な診断分析 |
| `rag_manual.py` | RAGマニュアル検索 | マニュアルから関連情報を検索 |
| `logger.py` | ログ記録 | 診断結果をファイルに保存 |
| `debug_logger.py` | デバッグログ | 開発用の詳細ログ出力 |
| `utils.py` | ユーティリティ関数 | 便利な補助機能 |
| `scenario_config.py` | シナリオ読み込み | scenario.iniを読み込む |

---

## 🎨 protos/ - 3Dモデル定義

PROTOファイルは、Webotsで使う3Dモデルの設計図です。

### custom/ - カスタムモデル（このプロジェクト専用）

| ファイル名 | 役割 |
|-----------|------|
| `BuriedBox.proto` | 埋没ボックス | 脚が埋まる箱のモデル |
| `SandPatch.proto` | 砂エリア | 砂地のモデル |
| `RealisticMavic2Pro.proto` | リアルなドローン | DJI Mavic 2 Proの精密モデル（バッテリー消費等を再現） |

### vendor/ - 既製品モデル（Webots公式等）

**appearances/** - 材質・テクスチャ
- 金属、プラスチック、布、砂など様々な素材の見た目を定義

**projects/robots/** - ロボットモデル
- `boston_dynamics/spot/` - Spotのモデルと部品
- `dji/mavic/` - DJI Mavic 2 Proのモデル

**projects/objects/** - 環境オブジェクト
- `floors/` - 床・地面のモデル

---

## 🌍 worlds/ - シミュレーション環境

| ファイル名 | 役割 |
|-----------|------|
| `sotuken_world.wbt` | メインシミュレーション環境 | Spot、ドローン、障害物等を配置したメイン環境 |
| `test_drone.wbt` | ドローンテスト環境 | ドローン単体のテスト用 |

---

## 🔗 ファイル間の関係性

### 1. シミュレーション起動の流れ

```
① webots起動
    ↓
② sotuken_world.wbt 読み込み
    ↓  
③ 各ロボットのコントローラーが起動
    - spot_self_diagnosis.py
    - drone_circular_controller.py
    - environment_manager.py
```

### 2. 設定ファイルの使われ方

```
scenario.ini
    ↓ 読み込み
scenario_config.py
    ↓ データ提供
spot_self_diagnosis.py & drone_circular_controller.py
    ↓
シミュレーション環境の初期化
```

### 3. 診断の流れ

```
【Spot側】
spot_self_diagnosis.py
    ↓ センサーデータ
self_diagnosis.py (diagnostics_pipeline)
    ↓ 自己診断結果
pipeline.py
    ↓ ドローンに診断依頼
drone_circular_controller.py

【ドローン側】
drone_circular_controller.py
    ↓ 画像観察
drone_observer.py (diagnostics_pipeline)
    ↓ 観察結果
pipeline.py
    ↓ 統合処理
fusion.py
    ↓ 必要に応じてAI分析
llm_advanced.py → llm_client.py
    ↓
最終診断結果
    ↓ 保存
logger.py → logsフォルダ
```

### 4. モデル読み込みの流れ

```
sotuken_world.wbt
    ↓ EXTERNPROTO で参照
RealisticMavic2Pro.proto (ドローン)
    ↓ メッシュファイル参照
Mavic2Pro/meshes/*.obj (3D形状データ)
    ↓ テクスチャ参照
textures/*.jpg (見た目の画像)
```

---

## 💡 初心者向けポイント

### どこから読めばいい？

1. **全体を知りたい** → `README.md`、`RUN_SIMULATION.md`
2. **動かしたい** → `RUN_SIMULATION.md` → `test_rule_based.py`実行
3. **プログラムを理解したい** → 以下の順番がおすすめ
   - `controllers/diagnostics_pipeline/config.py` (定数定義)
   - `controllers/diagnostics_pipeline/models.py` (データ構造)
   - `controllers/spot_self_diagnosis/spot_self_diagnosis.py` (Spotの動き)
   - `controllers/drone_circular_controller/drone_circular_controller.py` (ドローンの動き)
   - `controllers/diagnostics_pipeline/pipeline.py` (診断の流れ)

### 重要なファイルTop5

1. **drone_circular_controller.py** - ドローンの全制御
2. **spot_self_diagnosis.py** - Spotの全制御
3. **pipeline.py** - 診断システムの中枢
4. **scenario.ini** - シミュレーション設定
5. **sotuken_world.wbt** - シミュレーション環境

---

## 📊 ファイル数まとめ

| カテゴリ | 数 | 主な内容 |
|---------|---|---------|
| ドキュメント | 7ファイル | プロジェクト説明、仕様書 |
| Pythonスクリプト | 17ファイル | ロボット制御、診断システム |
| 設定ファイル | 5ファイル | シナリオ、環境設定 |
| PROTOファイル（カスタム） | 3ファイル | 独自3Dモデル |
| Worldファイル | 2ファイル | シミュレーション環境 |
| Vendorファイル | 多数 | 既製品モデル・素材 |

---

## ❓ よくある質問

**Q: vendorフォルダは何？**
A: Webots公式が提供する既製品モデルです。自分で編集する必要はありません。

**Q: どのファイルを編集すればいい？**
A: 主に以下のファイルを編集します：
- `controllers/`内のPythonファイル（ロボット動作）
- `config/scenario.ini`（シミュレーション設定）
- `protos/custom/`のPROTOファイル（独自モデル）

**Q: logsフォルダのファイルは？**
A: プログラムが自動生成する診断結果です。削除しても問題ありません。

**Q: __pycache__は何？**
A: Pythonが自動生成する実行ファイルです。無視してOKです。

---

**作成日**: 2025年12月1日
**対象**: 基礎プログラミング知識を持つ高専生向け
