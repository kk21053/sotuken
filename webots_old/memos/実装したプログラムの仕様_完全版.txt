卒業研究として、4足歩行ロボットの故障原因をドローンとの協調診断を用いて特定する研究をシミュレーションを用いて行う。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■1. 実施環境
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
・Webots R2023b（シミュレーター）
・Spot（Boston Dynamics社製4足歩行ロボット）
・DJI Mavic 2 PRO（ドローン、観測用）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■2. Webots内の環境設定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

2.1 脚ごとの環境設定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Spotの各脚（FL、FR、RL、RR）に対して個別の環境を設定できる。
各脚に設定できる環境は以下の5種類から1つのみ選択可能:
  - NONE（正常）
  - BURIED（埋まる）
  - TRAPPED（挟まる）
  - TANGLED（絡まる）
  - MALFUNCTION（故障）

※ 1つの脚が複数の環境を同時に設定することはできない。

2.2 環境設定の変更方法
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
簡易スクリプト「set_environment.py」を実行することで環境を変更できる。
使用例:
  python3 set_environment.py NONE BURIED TRAPPED NONE

実行すると、以下の2つのファイルが更新される:
  1. config/scenario.ini - 各脚の環境設定を記録
  2. worlds/sotuken_world.wbt - 環境オブジェクトの表示/非表示を制御

環境オブジェクトの制御方法:
  - BURIED設定時: BURIED_BOXの全子要素をFL脚の位置に配置
  - TRAPPED設定時: FOOT_TRAPをFL脚の位置に配置
  - TANGLED設定時: FOOT_VINEをFL脚の位置に配置
  - 未使用時: 各オブジェクトを地下100m (z=-100)に移動して非表示化

2.3 ドローンの配置
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ドローンはSpotを最も正確に診断できる位置に常に定住している。
主に計算処理を行うのはドローンとする。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■3. 診断の流れ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ1: Spotの自己診断（各脚6回ずつ）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Spotが各脚に対して6回ずつ内部診断を行い、それぞれ動くか動かないかを判断する。
診断内容は以下の通り:

Trial 1: motor[2]（膝関節） +4°
Trial 2: motor[2]（膝関節） -4°
Trial 3: motor[1]（股関節） +4°
Trial 4: motor[1]（股関節） -4°
Trial 5: motor[0]（肩関節） +4°
Trial 6: motor[0]（肩関節） -4°

各試行の診断基準は以下の4つの指標を統合して評価:
  self_can_raw = 追従性スコア×0.4 + 速度スコア×0.25 + トルクスコア×0.25 + 安全性スコア×0.1

指標の詳細:
  1) 追従性スコア（track）
     - 目標角度と測定角度の誤差を評価
     - score_track = 1.0 - (平均誤差 / E_MAX_DEG)
     - E_MAX_DEG = 3.0°

  2) 速度スコア（vel）
     - 関節の角速度を評価（正常脚は高速で動く）
     - score_vel = ピーク角速度 / OMEGA_REF_DEG_PER_SEC
     - OMEGA_REF_DEG_PER_SEC = 27.0°/s

  3) トルクスコア（tau）
     - 関節トルクが正常範囲内かを評価
     - score_tau = 1.0 - (平均トルク / トルク上限)
     - トルク上限 = 公称トルク × 0.8

  4) 安全性スコア（safe）
     - 安全レベルの評価
     - normal: 1.0, warn: 0.5, error: 0.0

この診断の際、Spotは各脚を動かす度にドローンへ「どの脚をどの程度動かすか」を通知する。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ2: ドローンによる姿勢監査（RoboPose使用）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ドローンはSpotから脚を動かすことを通知されると、その間ロボットの姿勢を監査し、
想定通りの動きをしているか診断する。姿勢の監査にはRoboPoseを用いる。

監査内容:
  - 脚の関節角度の変化量（delta_theta）
  - 脚先端の位置変化（end_disp）
  - 経路の長さ（path_length）
  - 経路の直進性（path_straightness）
  - 反転回数（reversals）
  - 本体の高さ（base_height）
  - 本体の姿勢（roll、pitch）

脚が拘束されている場合、Spotの胴体が動いてしまうことも考慮し、
それを含めた上で脚がどの程度動いたかを診断する。

各試行ごとに drone_can_raw を計算:
  drone_can_raw = clamp(delta_theta / DELTA_THETA_REF_DEG)
  DELTA_THETA_REF_DEG = 4.0°

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ3: Spot側のシグモイド変換（spot_can計算）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
全ての脚の診断が終わると、Spotは各脚の診断結果を確率に変換する。

6回の試行結果の平均値を取り、シグモイド関数で変換:
  avg_score = mean(self_can_raw[1~6])
  x = CONFIDENCE_STEEPNESS × (avg_score - SELF_CAN_THRESHOLD)
  spot_can = 1.0 / (1.0 + exp(-x))

パラメータ:
  SELF_CAN_THRESHOLD = 0.50（閾値）
  CONFIDENCE_STEEPNESS = 15.0（急峻度）

spot_canは各脚の動作確率を示す（0.0=動かない ～ 1.0=動く）。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ4: ドローン側のシグモイド変換と拘束原因推定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
全ての脚の診断が終わると、ドローンは以下を行う:

4.1 drone_canの計算
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
6回の試行結果の平均値をシグモイド変換:
  avg_score = mean(drone_can_raw[1~6])
  x = CONFIDENCE_STEEPNESS × (avg_score - SELF_CAN_THRESHOLD)
  drone_can = 1.0 / (1.0 + exp(-x))

パラメータはSpotと同じ値を使用。

4.2 ロバスト統計による特徴量計算
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
物理シミュレーションの累積誤差や外れ値の影響を排除するため、
6回の試行から各特徴量の中央値を計算:
  median_delta_theta = median([trial1.delta_theta, ..., trial6.delta_theta])
  median_end_disp = median([trial1.end_disp, ..., trial6.end_disp])
  （以下、全特徴量について同様）

4.3 拘束原因の確率分布推論（p_drone）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
中央値特徴量を用いて、各脚の拘束状況が「NONE、BURIED、TRAPPED、
TANGLED、MALFUNCTION、FALLEN」のどれなのかを確率で推論する。

実装された判定ロジック:

【優先度1: FALLEN（転倒）判定】
  条件: max_roll > 20° OR max_pitch > 20°
  → FALLEN確率を0.95に設定、他は0.01
  
【優先度2: BURIED（埋まる）判定】
  条件: 
    - end_disp < 5mm（足先がほとんど動かない）
    AND
    - delta_theta < 0.8°（関節もほとんど動かない）
  → BURIED確率 = 0.85

【優先度3: TRAPPED（挟まる）判定】
  重要: TRAPPEDは「関節は動くが足先が制限される」状態
  
  前提条件: BURIEDでないこと
  
  判定手順:
    1) 正常判定の優先
       end_disp >= 15mm → TRAPPED確率 = 0.0（正常動作と判定）
    
    2) TRAPPED判定
       条件:
         - delta_theta >= 2.0°（関節は動く）
         AND
         - 5mm < end_disp < 12mm（足先は制限される）
       → TRAPPED確率 = 0.75 + 0.20 × (1.0 - end_disp/12mm)
          （足先の変位が小さいほど確率が高い）

  パラメータの詳細:
    - TRAPPED_ANGLE_MIN = 2.0°（関節が動く最小角度）
    - TRAPPED_DISPLACEMENT_MAX = 12mm（足先の制限を示す上限）
    - BURIED_DISPLACEMENT_THRESHOLD = 5mm（BURIED判定との境界）
    - NORMAL_DISPLACEMENT_MIN = 15mm（正常動作の最小変位）
  
  実機対応の考慮:
    - 後ろ脚(RL, RR)は構造上、前脚より変位が小さくなりやすい特性を考慮
    - 12mm～15mmの範囲は正常動作として扱い、誤検出を防止

【優先度4: TANGLED（絡まる）判定】
  前提条件: TRAPPEDでもBURIEDでもないこと
  
  条件:
    - path_straightness > 30.0（極端に不規則な経路）
    OR
    - reversals > 10（異常に多い反転回数）
  → TANGLED確率 = min(straightness_score + reversal_score)
    - straightness_score = min(0.5, (path_straightness - 30.0) / 100.0)
    - reversal_score = min(0.5, (reversals - 10) × 0.05)
  
  注: 正常な診断動作でも5-7回程度の反転は発生するため、
      閾値を10回以上に設定

【MALFUNCTION（故障）】
  ドローンからは観測不可のため、常に低確率（0.05）を設定

【NONE（正常）】
  異常スコアの残余確率として算出:
    max_abnormal_score = max(TRAPPED, TANGLED, BURIED)
    
    if max_abnormal_score > 0.7:
      NONE確率 = (1.0 - max_abnormal_score) × 0.5
    else:
      NONE確率 = 1.0 - max_abnormal_score

最終的に、全ての確率を正規化して合計が1.0になるように調整し、
p_droneに格納する。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ5: Spotからドローンへのデータ送信
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Spotは計算したspot_can（各脚の動作確率）をドローンへ送信する。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ6: ルールベースLLMへのデータ受け渡し
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ドローンは以下のデータをルールベースLLMへ渡す:
  - spot_can（Spotの動作確率）
  - drone_can（ドローンの動作確率）
  - p_drone（拘束原因の確率分布）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ7: ルールベースLLMによる最終判定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ルールベースLLMは、ドローンから受け取ったspot_can、drone_can、p_droneを
以下の4つのルールに基づいて比較し、最終的なp_can（動作確率）と
各脚の拘束原因を決定する。

【ルール①: 両方が0.7以上 → 動く】
  条件: spot_can >= 0.7 AND drone_can >= 0.7
  結果:
    - movement_result = "動く"
    - p_can = (spot_can + drone_can) / 2（平均値）
    - cause_final = "NONE"（正常）
    - p_llm = {
        NONE: 0.94,
        BURIED: 0.01,
        TRAPPED: 0.01,
        TANGLED: 0.01,
        MALFUNCTION: 0.02,
        FALLEN: 0.01
      }

【ルール②: 両方が0.3以下 → 動かない】
  条件: spot_can <= 0.3 AND drone_can <= 0.3
  結果:
    - movement_result = "動かない"
    - p_can = (spot_can + drone_can) / 2
    - cause_final = p_droneの中で最大確率の原因（ただしNONEを除く）
    - p_llm = {
        NONE: 0.02,
        [最大原因]: 0.89,
        [その他]: 0.02
      }
  
  理由: 「動かない」場合は正常(NONE)ではないため、
        異常原因の中から最も確率の高いものを選択

【ルール③: 片方が0.7以上、もう片方が0.3以下 → 動かない（故障）】
  条件: 
    (spot_can >= 0.7 AND drone_can <= 0.3)
    OR
    (spot_can <= 0.3 AND drone_can >= 0.7)
  結果:
    - movement_result = "動かない"
    - p_can = (spot_can + drone_can) / 2
    - cause_final = "MALFUNCTION"（故障）
    - p_llm = {
        NONE: 0.01,
        BURIED: 0.02,
        TRAPPED: 0.02,
        TANGLED: 0.01,
        MALFUNCTION: 0.93,
        FALLEN: 0.01
      }
  
  理由: Spotとドローンで判定が大きく食い違う場合は、
        センサー故障または測定エラーの可能性が高い

【ルール④: 片方が中間値 → 一部動く】
  条件: 上記①②③のいずれにも該当しない場合
        （0.3 < spot_can < 0.7 または 0.3 < drone_can < 0.7）
  結果:
    - movement_result = "一部動く"
    - p_can = (spot_can + drone_can) / 2
    - cause_final = p_droneの中で最大確率の原因（NONEを含む）
    - p_llm = {
        [最大原因]: 0.69,
        NONE: 0.10,
        [その他]: 0.05
      }
  
  理由: 中間的な状態では確信度が低いため、
        ドローンの観測結果を参考に判定

閾値パラメータ:
  CONFIDENCE_HIGH_THRESHOLD = 0.7（動くと判定する閾値）
  CONFIDENCE_LOW_THRESHOLD = 0.3（動かないと判定する閾値）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ8: 転倒判定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ドローンはSpotの姿勢を確認し、Spotが転倒しているかどうかを判定する。
この判定はステップ2の姿勢監査時に各試行ごとに実施済み。

判定条件:
  abs(roll) > 20° OR abs(pitch) > 20°
  → fallen = True

転倒確率の計算:
  fallen_probability = min(1.0, max_angle / (FALLEN_THRESHOLD_DEG × 2))
  
  ここで max_angle = max(abs(roll), abs(pitch))

転倒が検出された場合:
  - session.fallen = True
  - session.fallen_probability = fallen_probability
  - 該当する脚のp_droneをFALLEN優先に上書き

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ9: 結果の表示とログ記録
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
診断結果をコンソールに表示し、JSONLファイルに記録する。

9.1 コンソール表示
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
各脚について以下を表示:
  - 動作判定（動く/動かない/一部動く）
  - 最終動作確率（p_can）
  - 拘束原因（cause_final）
  - 期待値との比較（設定されている場合）

転倒判定結果も表示:
  - 転倒しているかどうか
  - 転倒確率

9.2 ログファイルへの記録
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
以下のファイルにJSONL形式で記録:
  - controllers/drone_circular_controller/logs/leg_diagnostics_events.jsonl
    → 各試行（Trial）の詳細データ
  
  - controllers/drone_circular_controller/logs/leg_diagnostics_sessions.jsonl
    → セッション全体の診断結果サマリー

記録内容:
  - セッションID
  - 各脚のspot_can、drone_can、p_can
  - 各脚の拘束原因（cause_final）
  - 各脚の動作判定（movement_result）
  - 転倒判定結果
  - タイムスタンプ

9.3 結果確認スクリプト
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
view_result.pyを実行することで、最新の診断結果を確認可能:
  python3 view_result.py

表示内容:
  - 各脚の動作判定と拘束原因
  - 期待値との一致/不一致
  - 診断精度（正解率）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■4. 主要なプログラムファイル
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

4.1 環境設定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
set_environment.py
  - 各脚の環境を設定
  - scenario.iniとsotuken_world.wbtを更新

4.2 診断パイプライン
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
controllers/diagnostics_pipeline/
  - pipeline.py: 診断フローの統括
  - self_diagnosis.py: Spotの自己診断（ステップ1, 3）
  - drone_observer.py: ドローンの観測と分析（ステップ2, 4, 8）
  - llm_client.py: ルールベースLLM（ステップ7）
  - config.py: 各種パラメータの定義
  - models.py: データモデルの定義
  - logger.py: ログ記録（ステップ9）

4.3 結果確認
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
view_result.py
  - 最新の診断結果を表示
  - 診断精度を計算

4.4 テスト実行
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
run_all_tests.sh
  - 複数のシナリオを自動実行
  - 各シナリオの診断精度を確認


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■5. 設定パラメータ一覧
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

5.1 試行設定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TRIAL_COUNT = 6（各脚の試行回数）
TRIAL_DURATION_S = 0.4（各試行の時間）
TRIAL_ANGLE_DEG = 4.0（各試行の角度変化）

5.2 自己診断の重み
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SELF_WEIGHTS = {
  "track": 0.4,   # 追従性スコア
  "vel": 0.25,    # 速度スコア
  "tau": 0.25,    # トルクスコア
  "safe": 0.1     # 安全性スコア
}

5.3 自己診断の評価パラメータ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
E_MAX_DEG = 3.0（追従誤差の最大値）
OMEGA_REF_DEG_PER_SEC = 27.0（基準角速度）
TAU_LIMIT_RATIO = 0.8（トルク上限比率）

5.4 シグモイド変換パラメータ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SELF_CAN_THRESHOLD = 0.50（閾値）
CONFIDENCE_STEEPNESS = 15.0（急峻度）

5.5 ルールベースLLMの閾値
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
CONFIDENCE_HIGH_THRESHOLD = 0.7（動くと判定）
CONFIDENCE_LOW_THRESHOLD = 0.3（動かないと判定）

5.6 ドローン観測の閾値（拘束原因判定用）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TRAPPED_ANGLE_MIN = 2.0°（TRAPPEDで関節が動く最小角度）
TRAPPED_DISPLACEMENT_MAX = 12mm（TRAPPEDで足先が制限される上限）
BURIED_ANGLE_THRESHOLD = 0.8°（BURIEDで動かない閾値）
BURIED_DISPLACEMENT_THRESHOLD = 5mm（BURIEDで動かない閾値）
NORMAL_DISPLACEMENT_MIN = 15mm（正常動作の最小変位）

5.7 転倒判定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
FALLEN_THRESHOLD_DEG = 20.0°（転倒と判定する角度）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■6. 拘束原因の定義
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

NONE（正常）
  - 脚は正常に動作しており障害がない状態

BURIED（埋まる）
  - 脚が地面や砂に埋まっており大きく持ち上げられない状態
  - 関節も足先もほとんど動かない

TRAPPED（挟まる）
  - 関節は動くのに末端が障害物等に固定され前進できない状態
  - 関節は動くが足先が制限される

TANGLED（絡まる）
  - ツタなどに絡まり小さい往復でしか動けない状態
  - 異常に不規則な経路パターン

MALFUNCTION（故障）
  - センサー故障または測定エラー
  - 物理的に矛盾する状態（Spotとドローンの判定が大きく食い違う）

FALLEN（転倒）
  - ロボットが転倒しており正常な診断が困難な状態
  - 本体の傾き（roll/pitch）が20度を超える


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■7. 実装上の特記事項
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

7.1 ロバスト統計の採用
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
物理シミュレーションでは累積誤差や試行順序の影響により、
一部の試行で異常値（外れ値）が発生する可能性がある。
これに対処するため、6回の試行データから中央値を計算し、
中央値を代表値として拘束原因を判定する。

中央値の利点:
  - 平均値と異なり、極端な値の影響を受けにくい
  - 6試行中2試行が異常でも残り4試行の中央値が使われる
  - より安定した診断結果が得られる

7.2 実機対応の考慮
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
閾値設定において、実際のロボットの構造特性を考慮:
  - 後ろ脚(RL, RR)は前脚(FL, FR)より変位が小さくなりやすい
  - 正常動作の範囲を適切に設定（15mm以上）
  - 物理的拘束を確実に検出（TRAPPED: 5-12mm、BURIED: 5mm未満）

7.3 三段階判定ロジック
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
拘束原因の判定は優先度順に実施:
  1. BURIED判定（最優先）: 関節も足先も動かない
  2. TRAPPED判定: 関節は動くが足先が制限される
     ただし、足先が15mm以上動く場合は正常と判定（誤検出防止）
  3. NONE判定: 異常が検出されない場合

この優先順位により、境界ケースでも正確な判定が可能。

7.4 処理性能
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ルールベースLLMの処理時間: 0.1ms未満/脚
メモリ使用量: 1KB未満
外部依存なし


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
以上
