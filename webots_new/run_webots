#!/usr/bin/env python3
# 映像出力ありでWebotsを起動する最小コマンド
# 使い方:
#   - 現状の環境でそのまま起動: ./run_webots
#   - 起動前に環境設定(FL FR RL RR)を適用: ./run_webots NONE BURIED TRAPPED NONE
#     ※ 引数は4つ固定（順に FL FR RL RR）。無効な値は set_environment が検証します。
# オプション:
#   --stream            # GUIが出せない環境向け。Webotsのストリーミングを有効化
#   --stream-port <p>   # ストリーミングポート番号（省略時はWebotsの既定値）
#   --gui-console       # Webots内のGUIコンソールを使用（下部へドッキングはWebots側レイアウト依存）

import os
import subprocess
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
WORLD = ROOT / "worlds" / "sotuken_world.wbt"
SET_ENV = ROOT / "set_environment"


def main() -> None:
    args = sys.argv[1:]

    # オプション処理（--stream/--stream-port）
    stream = False
    stream_port = None
    use_gui_console = False
    if "--stream" in args:
        stream = True
        args = [a for a in args if a != "--stream"]
    if "--stream-port" in args:
        try:
            i = args.index("--stream-port")
            stream_port = args[i + 1]
            args = args[:i] + args[i+2:]
        except Exception:
            print("エラー: --stream-port の指定が不正です。例: --stream-port 20000")
            sys.exit(1)
    if "--gui-console" in args:
        use_gui_console = True
        args = [a for a in args if a != "--gui-console"]

    # 引数が4つなら、起動前に環境設定を適用する（簡易）
    if len(args) == 4:
        envs = args
        print("環境設定を適用します:", "FL=", envs[0], "FR=", envs[1], "RL=", envs[2], "RR=", envs[3])
        subprocess.run([str(SET_ENV), *envs], check=True)
    elif len(args) not in (0, 4):
        print("使い方: ./run_webots [--stream [--stream-port P]] [--gui-console] [FL FR RL RR]")
        print("例:    ./run_webots NONE BURIED TRAPPED NONE")
        print("       ./run_webots --stream --stream-port 20000")
        print("       ./run_webots --gui-console")
        sys.exit(1)

    if not WORLD.exists():
        print("エラー: ワールドが見つかりません:", WORLD)
        sys.exit(1)

    # GUIを確実に有効化（もしヘッドレス系の環境変数があれば解除）
    for k in ("WEBOTS_HEADLESS", "WEBOTS_DISABLE_GUI", "QT_QPA_PLATFORM"):
        if os.environ.get(k):
            print(f"環境変数 {k} を無効化してGUI表示を試みます")
            os.environ.pop(k, None)

    # ストリーミング指定時はGUIが出せない環境でも映像を確認可能
    cmd = ["webots"]
    if stream:
        cmd.append("--stream")
        if stream_port is not None:
            cmd.extend(["--stream-port", str(stream_port)])
        print("ストリーミングを有効化して起動します。（ブラウザで表示可能）")

    # 既定でGUIコンソールを使わず、端末へ出力（画面占有を避ける）
    if use_gui_console:
        pass
    else:
        cmd.extend(["--stdout", "--stderr"])  # コントローラの出力を端末にリダイレクト

    cmd.append(str(WORLD))

    # GUI起動の事前チェック
    if not stream and ("DISPLAY" not in os.environ and "WAYLAND_DISPLAY" not in os.environ):
        print("警告: DISPLAY/WAYLAND_DISPLAY が未設定です。GUIウィンドウが表示されない可能性があります。")
        print("       必要に応じて --stream オプションをご利用ください。例: ./run_webots --stream")

    print("Webotsを起動します:", " ".join(cmd))
    try:
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError as e:
        print("Webotsの起動に失敗しました。GUI未対応環境の可能性があります。--stream の利用を検討してください。")
        raise


if __name__ == "__main__":
    main()
