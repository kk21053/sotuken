#!/usr/bin/env python3
# 映像出力ありでWebotsを起動する最小コマンド
# 使い方:
#   - 現状の環境でそのまま起動: ./run_webots
#   - 起動前に環境設定(FL FR RL RR)を適用: ./run_webots NONE BURIED TRAPPED NONE
#     ※ 引数は4つ固定（順に FL FR RL RR）。無効な値は set_environment が検証します。
# オプション:
#   --stream            # GUIが出せない環境向け。Webotsのストリーミングを有効化
#   --stream-port <p>   # ストリーミングポート番号（省略時はWebotsの既定値）
#   --headless          # 映像出力なし（WebotsのGUI/3D描画を抑制）で起動
#                       # 具体的には WEBOTS_HEADLESS=1 を設定し、webots に --no-rendering --batch を付与
#   --gui-console       # 互換用（非推奨）: Webots内のGUIコンソールを使わず、従来通り起動するだけ
#                     # ※Webots内コンソールの「位置/サイズ」はCLIから確実に制御できないため、
#                     #   出力は常に端末(=VS Codeなら画面下部)へ出す。
#
# Qwen(LLM) オプション（diagnostics_pipeline/llm_client.py が参照する環境変数を設定）:
#   --qwen-enable                 # QWEN_ENABLE=1 を設定
#   --qwen-disable                # QWEN_ENABLE=0 を設定
#   --qwen-gguf-path <path.gguf>  # QWEN_GGUF_PATH を設定

import os
import subprocess
import sys
from pathlib import Path

ROOT = Path(__file__).resolve().parent
WORLD = ROOT / "worlds" / "sotuken_world.wbt"
SET_ENV = ROOT / "set_environment"


def _prepend_pythonpath(path: Path) -> None:
    p = str(path)
    cur = os.environ.get("PYTHONPATH", "")
    if not cur:
        os.environ["PYTHONPATH"] = p
        return
    parts = [x for x in cur.split(":") if x]
    if p in parts:
        return
    os.environ["PYTHONPATH"] = p + ":" + cur


def main() -> None:
    args = sys.argv[1:]

    # オプション処理（--stream/--stream-port）
    stream = False
    stream_port = None
    use_gui_console = False
    headless = False
    no_rendering = False
    batch = False
    minimize = False

    qwen_enable: bool | None = None
    qwen_gguf_path: str | None = None

    if "--headless" in args:
        headless = True
        args = [a for a in args if a != "--headless"]
        # headless は映像出力抑制目的なので、描画停止 + ポップアップ抑制を既定で有効化
        no_rendering = True
        batch = True
        minimize = True

    # Webots の描画/挙動オプションを透過
    if "--no-rendering" in args:
        no_rendering = True
        args = [a for a in args if a != "--no-rendering"]
    if "--batch" in args:
        batch = True
        args = [a for a in args if a != "--batch"]
    if "--minimize" in args:
        minimize = True
        args = [a for a in args if a != "--minimize"]

    if "--stream" in args:
        stream = True
        args = [a for a in args if a != "--stream"]
    if "--stream-port" in args:
        try:
            i = args.index("--stream-port")
            stream_port = args[i + 1]
            args = args[:i] + args[i+2:]
        except Exception:
            print("エラー: --stream-port の指定が不正です。例: --stream-port 20000")
            sys.exit(1)
    if "--gui-console" in args:
        use_gui_console = True
        args = [a for a in args if a != "--gui-console"]

    # Qwen オプション
    if "--qwen-enable" in args:
        qwen_enable = True
        args = [a for a in args if a != "--qwen-enable"]
    if "--qwen-disable" in args:
        qwen_enable = False
        args = [a for a in args if a != "--qwen-disable"]
    if "--qwen-gguf-path" in args:
        try:
            i = args.index("--qwen-gguf-path")
            qwen_gguf_path = args[i + 1]
            args = args[:i] + args[i + 2 :]
        except Exception:
            print("エラー: --qwen-gguf-path の指定が不正です。例: --qwen-gguf-path /path/to/model.gguf")
            sys.exit(1)

    # 引数が4つなら、起動前に環境設定を適用する（簡易）
    if len(args) == 4:
        envs = args
        print("環境設定を適用します:", "FL=", envs[0], "FR=", envs[1], "RL=", envs[2], "RR=", envs[3])
        subprocess.run([str(SET_ENV), *envs], check=True)
    elif len(args) not in (0, 4):
        print(
            "使い方: ./run_webots [--headless] [--no-rendering] [--batch] [--minimize] "
            "[--stream [--stream-port P]] [--gui-console] "
            "[--qwen-enable|--qwen-disable] [--qwen-gguf-path PATH] [FL FR RL RR]"
        )
        print("例:    ./run_webots NONE BURIED TRAPPED NONE")
        print("       ./run_webots --stream --stream-port 20000")
        print("       ./run_webots --headless")
        print("       ./run_webots --headless --qwen-enable --qwen-gguf-path /path/to/model.gguf")
        print("       ./run_webots --gui-console")
        sys.exit(1)

    if not WORLD.exists():
        print("エラー: ワールドが見つかりません:", WORLD)
        sys.exit(1)

    # Qwen の環境変数を必要に応じて設定
    if qwen_enable is not None:
        os.environ["QWEN_ENABLE"] = "1" if qwen_enable else "0"
    if qwen_gguf_path is not None:
        os.environ["QWEN_GGUF_PATH"] = str(qwen_gguf_path)

    # Qwen を使う場合、Webotsが起動する各Pythonコントローラが .venv の依存を読めるようにする。
    # （Webotsは通常 system python3 で controller *.py を実行するため）
    qwen_enabled = (qwen_enable is True) or (os.environ.get("QWEN_ENABLE") == "1")
    if qwen_enabled:
        venv_site = ROOT / ".venv" / "lib" / f"python{sys.version_info.major}.{sys.version_info.minor}" / "site-packages"
        if venv_site.exists():
            _prepend_pythonpath(venv_site)

    if headless:
        # 映像出力を抑制する（GUIを開かない/描画しない）
        os.environ["WEBOTS_HEADLESS"] = "1"
        os.environ["WEBOTS_DISABLE_GUI"] = "1"
        # QtがGUIデバイスを要求する環境での失敗を避ける（存在すれば上書き）
        os.environ.setdefault("QT_QPA_PLATFORM", "offscreen")
    else:
        # GUIを確実に有効化（もしヘッドレス系の環境変数があれば解除）
        for k in ("WEBOTS_HEADLESS", "WEBOTS_DISABLE_GUI", "QT_QPA_PLATFORM"):
            if os.environ.get(k):
                print(f"環境変数 {k} を無効化してGUI表示を試みます")
                os.environ.pop(k, None)

    # ストリーミング指定時はGUIが出せない環境でも映像を確認可能
    cmd = ["webots"]
    if no_rendering:
        cmd.append("--no-rendering")
    if batch:
        cmd.append("--batch")
    if minimize:
        cmd.append("--minimize")
    if stream:
        cmd.append("--stream")
        if stream_port is not None:
            cmd.extend(["--stream-port", str(stream_port)])
        print("ストリーミングを有効化して起動します。（ブラウザで表示可能）")

    # コントローラの出力は常に端末へ出す（VS Codeの統合ターミナルなら画面下部に表示される）
    # Webots内GUIコンソールのドッキング位置/サイズは、ユーザ環境のレイアウト設定に依存し
    # CLIからの確実な制御ができないため。
    if use_gui_console:
        print("注意: --gui-console は非推奨です。出力は端末へリダイレクトします（画面下部）。")
    cmd.extend(["--stdout", "--stderr"])

    cmd.append(str(WORLD))

    # GUI起動の事前チェック
    if not headless and not stream and ("DISPLAY" not in os.environ and "WAYLAND_DISPLAY" not in os.environ):
        print("警告: DISPLAY/WAYLAND_DISPLAY が未設定です。GUIウィンドウが表示されない可能性があります。")
        print("       必要に応じて --stream オプションをご利用ください。例: ./run_webots --stream")

    print("Webotsを起動します:", " ".join(cmd))
    try:
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError as e:
        print("Webotsの起動に失敗しました。GUI未対応環境の可能性があります。--stream の利用を検討してください。")
        raise


if __name__ == "__main__":
    main()
